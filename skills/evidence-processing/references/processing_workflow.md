# 証憑処理ワークフロー

`証憑/` から `処理/` への変換を5段階で行う。

## 段階 1: 明細の書き起こし (01-03)

### 01_クレジットカード明細.md

**入力**: `証憑/04_クレジットカード/csv/` の CSV ファイル

**処理手順**:
1. CSV を読み取り、利用日・利用店名・金額・備考をテーブル化
2. 月ごとにセクション分け（請求月 or 利用月）
3. 各月の請求合計額を記載

**出力例**:
```markdown
# クレジットカード明細（○○カード）

## 2501
- お支払日: 2025/01/07
- 今回ご請求額: 100,000円

| 利用日 | ご利用店名 | 利用金額 | 備考 |
| --- | --- | --- | --- |
| 2024/11/15 | サンプルサービス | 5,000 | |
| 2024/12/01 | サンプルストア | 3,000 | |
```

### 02_電子決済明細.md

**入力**: `証憑/05_paypay/` の CSV ファイル（PayPay 等の取引履歴）

**処理手順**:
1. CSV を読み取り、取引日・取引先・金額をテーブル化
2. 事業用途の取引を抽出（私用取引は除外）

### 03_銀行口座明細.md

**入力**: `証憑/03_銀行口座/` のスクリーンショット（JPG/PNG）

**処理手順**:
1. `image-describer` スキルで画像を OCR
2. 取引日・摘要・入出金額をテーブル化

## 段階 2: 売上請求書の整理 (04)

### 04_売上請求書.md

**入力**: `証憑/01_弊社から顧客への請求書/` の PDF ファイル

**処理手順**:
1. 請求書 PDF を読み取り、取引先名・件名・税抜金額・消費税・税込金額・入金期限をテーブル化
2. 取引先ごとにセクション分け

**出力例**:
```markdown
# 売上請求書一覧（2025年度）

| 請求日 | 顧客 | 件名 | 税抜 | 消費税 | 税込 | 入金期限 |
| --- | --- | --- | ---: | ---: | ---: | --- |
| 2025/03/05 | サンプル商事 | システム開発 2月分 | 400,000 | 40,000 | 440,000 | 2025/03/25 |
```

## 段階 3: 経費証憑の書き起こし (05a-05d)

### 05a_サブスク経費.md

**入力**: `証憑/02_業者から弊社への請求書・領収書/` 内のサブスク関連フォルダ

**処理手順**:
1. 各ベンダーフォルダの請求書・領収書を `image-describer` で OCR
2. ベンダーごとにセクション分け、月次の利用額をテーブル化
3. 勘定科目（通信費等）を付記

### 05b_amazon経費.md

**入力**: Amazon 注文関連の請求書

**処理手順**:
1. 注文日・商品名・金額をテーブル化
2. 勘定科目（消耗品費・通信費等）を判定して付記

### 05c_その他領収書.md

**入力**: 個別の領収書ファイル（JPG/PDF）

**処理手順**:
1. 各領収書を `image-describer` で OCR
2. 日付・支払先・金額・勘定科目をテーブル化

### 05d_その他経費.md

**入力**: 上記カテゴリに当てはまらない経費

**処理手順**:
1. 口座振替等、証憑が通帳記載のみのものをリスト化
2. 日付・内容・金額・勘定科目をテーブル化

## 段階 4: 仕訳対象の一覧化 (06)

### 06_仕訳対象事象一覧.md

01-05 の書き起こしを横断的に整理し、以下のカテゴリで分類:

1. **売上**: 請求書ベースの売上計上
2. **売掛金入金**: 銀行口座への入金
3. **CC 事業経費**: クレジットカード利用の事業経費
4. **現金経費**: 現金支払いの事業経費
5. **電子決済経費**: PayPay 等の決済
6. **口座振替経費**: 自動引落の経費

**出力例**:
```markdown
# 仕訳対象事象一覧（2025年度）

## 1. 売上
| 請求日 | 顧客 | 件名 | 税込金額 |
| --- | --- | --- | ---: |
| 2025/03/05 | サンプル商事 | システム開発 2月分 | 440,000 |

## 2. CC 事業経費
| 利用日 | 利用店名 | 金額 | 勘定科目 |
| --- | --- | ---: | --- |
| 2025/01/01 | SAMPLE CLOUD SERVICE | 5,000 | 通信費 |
```

## 段階 5: 仕訳データの生成 (07)

### 07_仕訳一覧.md

06 の事象一覧を元に、正式な複式簿記の仕訳を作成する。

**必須セクション**:
1. **会計方針**: 経費処理の前提（事業用口座の有無、CC 経費の処理方法等）
2. **勘定科目一覧**: 使用する全勘定科目の `科目名 | entity_id | 種別` テーブル
3. **仕訳一覧**: `No | 日付 | 摘要 | 借方科目 | 貸方科目 | 金額` テーブル
4. **勘定科目別集計**: 経費科目ごとの合計
5. **損益概要**: 売上・経費・差引利益

詳細フォーマットは [output_format_md.md](output_format_md.md) を参照。

### 07_仕訳データ.json

`md_to_json.py` スクリプトで `07_仕訳一覧.md` から自動生成する。

```bash
python scripts/md_to_json.py <処理/07_仕訳一覧.md のパス>
```

詳細フォーマットは [output_format_json.md](output_format_json.md) を参照。
